language: php

php:
  - 5.6

env:
  global:
    - APP_KEY=SomeRandom32CharString
    - APP_ENV=testing
    - APP_DEBUG=true
    - DB_HOST=127.0.0.1
    - DB_DATABASE=horsestories_testing
    - DB_USERNAME=shippable
    - DB_PASSWORD=
    - MAIL_PRETEND=true

archive: true

cache: true

before_script:
  - echo "xdebug.max_nesting_level = 200" >> ~/.phpenv/versions/5.6/etc/php.ini
  - mkdir -p shippable/testresults
  - mkdir -p shippable/codecoverage
  - mysql -e "CREATE DATABASE IF NOT EXISTS $DB_DATABASE"
  - composer self-update --no-interaction
  - composer install --prefer-dist --no-interaction
  - php artisan migrate --seed

script:
  - ./vendor/bin/phpspec run --no-code-generation
  - ./vendor/bin/phpunit --configuration phpunit.xml

after_script:
  - cp -r storage/logs shippable/logs
